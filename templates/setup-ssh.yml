steps:
- task: Bash@3
  displayName: 'Setup SSH Keys for VMs'
  inputs:
    targetType: 'inline'
    script: |
      echo "üîë Setting up SSH keys for VM access..."
      
      # Generate SSH key if it doesn't exist
      if [ ! -f ~/.ssh/id_rsa ]; then
        echo "Generating SSH key..."
        mkdir -p ~/.ssh
        ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
        chmod 600 ~/.ssh/id_rsa
        chmod 644 ~/.ssh/id_rsa.pub
      fi
      
      # Copy SSH key to all VMs
      for vm in k8s-master k8s-worker1 k8s-worker2; do
        echo "Setting up SSH key for $vm..."
        
        # Get VM IP
        VM_IP=$(multipass info $vm | grep IPv4 | awk '{print $2}')
        
        # Use multipass mount to copy the key (avoids permission issues)
        multipass exec $vm -- mkdir -p /home/ubuntu/.ssh
        
        # Copy key content directly via multipass exec
        PUB_KEY=$(cat ~/.ssh/id_rsa.pub)
        multipass exec $vm -- bash -c "echo '$PUB_KEY' >> /home/ubuntu/.ssh/authorized_keys"
        multipass exec $vm -- bash -c "chmod 600 /home/ubuntu/.ssh/authorized_keys"
        multipass exec $vm -- bash -c "chmod 700 /home/ubuntu/.ssh"
        multipass exec $vm -- bash -c "chown -R ubuntu:ubuntu /home/ubuntu/.ssh"
        
        echo "‚úÖ SSH key setup complete for $vm ($VM_IP)"
      done
      
      # Test SSH connection
      echo "üß™ Testing SSH connections..."
      for vm in k8s-master k8s-worker1 k8s-worker2; do
        VM_IP=$(multipass info $vm | grep IPv4 | awk '{print $2}')
        if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 ubuntu@$VM_IP "echo 'SSH test successful'" 2>/dev/null; then
          echo "‚úÖ SSH connection to $vm ($VM_IP) successful"
        else
          echo "‚ùå SSH connection to $vm ($VM_IP) failed"
        fi
      done