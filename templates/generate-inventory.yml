steps:
- task: Bash@3
  displayName: 'Generate Dynamic Inventory'
  inputs:
    targetType: 'inline'
    script: |
      echo "üîç Detecting VM IPs..."
      
      # Get current VM IPs
      MASTER_IP=$(multipass info k8s-master | grep IPv4 | awk '{print $2}')
      WORKER1_IP=$(multipass info k8s-worker1 | grep IPv4 | awk '{print $2}')
      WORKER2_IP=$(multipass info k8s-worker2 | grep IPv4 | awk '{print $2}')
      
      echo "Master IP: $MASTER_IP"
      echo "Worker1 IP: $WORKER1_IP" 
      echo "Worker2 IP: $WORKER2_IP"
      
      # Generate dynamic inventory
      cat > ansible/inventory.ini << EOF
      [k8s_master]
      k8s-master ansible_host=$MASTER_IP ansible_user=ubuntu

      [k8s_workers]
      k8s-worker1 ansible_host=$WORKER1_IP ansible_user=ubuntu
      k8s-worker2 ansible_host=$WORKER2_IP ansible_user=ubuntu

      [k8s_cluster:children]
      k8s_master
      k8s_workers

      [all:vars]
      ansible_ssh_common_args='-o StrictHostKeyChecking=no'
      ansible_python_interpreter=/usr/bin/python3
      EOF
      
      echo "‚úÖ Generated dynamic inventory:"
      cat ansible/inventory.ini
      
      # Configure git and commit back to repo
      git config user.email "pipeline@azuredevops.com"
      git config user.name "Azure DevOps Pipeline"
      
      # Check if inventory changed
      if ! git diff --quiet ansible/inventory.ini; then
        echo "üìù Committing updated inventory..."
        git add ansible/inventory.ini
        git commit -m "Update inventory with current VM IPs [skip ci]"
        
        # Fix git push for pipeline
        git checkout main 2>/dev/null || git checkout -b main
        git push https://github.com/Harry142/k8s-infrastructure.git main 2>/dev/null || echo "Push failed, but inventory is updated locally"
        echo "‚úÖ Inventory committed to repository"
      else
        echo "‚ÑπÔ∏è Inventory unchanged, no commit needed"
      fi