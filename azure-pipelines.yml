trigger:
- main

pool:
  name: 'Default'  # Change from 'Self-Hosted' to 'Default'

stages:
- stage: Infrastructure
  jobs:
  - job: CreateVMs
    steps:
    - task: Bash@3
      displayName: 'Create Multipass VMs'
      inputs:
        targetType: 'filePath'
        filePath: 'scripts/create-vms.sh'

- stage: Kubernetes
  dependsOn: Infrastructure  # Add dependency
  jobs:
  - job: SetupK8s
    steps:
    - task: Bash@3
      displayName: 'Setup Kubernetes'
      inputs:
        targetType: 'filePath'
        filePath: 'scripts/setup-k8s-v2.sh'

- stage: Deploy
  dependsOn: Kubernetes  # Add deployment stage
  jobs:
  - job: DeployApps
    steps:
    - task: Bash@3
      displayName: 'Deploy Applications'
      inputs:
        targetType: 'inline'
        script: |
          kubectl apply -f k8s/nginx.yaml
          kubectl get pods
          kubectl get svc nginx-service
