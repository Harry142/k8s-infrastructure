name: Kubernetes Setup Only
trigger: none  # Manual only

pool:
  name: 'Default'

parameters:
- name: action
  displayName: 'Kubernetes Action'
  type: string
  default: 'setup'
  values:
  - setup
  - reset
  - rejoin-workers
  - status
  - restart-services
  - install-calico

stages:
- stage: KubernetesAction
  displayName: 'Kubernetes Operations'
  jobs:
  - job: K8sAction
    displayName: 'Kubernetes ${{ parameters.action }}'
    steps:
    - template: ../templates/setup-ssh.yml
    - template: ../templates/generate-inventory.yml
    
    - task: Bash@3
      displayName: 'Kubernetes Action: ${{ parameters.action }}'
      timeoutInMinutes: 30
      inputs:
        targetType: 'inline'
        script: |
          case "${{ parameters.action }}" in
            "setup")
              echo "üöÄ Setting up Kubernetes cluster..."
              
              # Fix repository issues
              sudo rm -f /etc/apt/sources.list.d/hashicorp.list
              sudo rm -f /etc/apt/sources.list.d/mikhailnov-ubuntu-pulseeffects-jammy.list
              sudo apt update 2>/dev/null || true
              
              # Install ansible
              sudo apt install -y ansible || {
                echo "Trying pip installation..."
                sudo apt install -y python3-pip
                pip3 install ansible
                export PATH="$HOME/.local/bin:$PATH"
              }
              
              # Run ansible playbook
              ansible-playbook -i ansible/inventory.ini ansible/playbook.yml
              
              # Ensure Calico is installed (backup check)
              echo "üîç Verifying Calico installation..."
              mkdir -p ~/.kube
              multipass exec k8s-master -- sudo cat /etc/kubernetes/admin.conf > ~/.kube/config
              
              if ! kubectl get pods -n calico-system &>/dev/null; then
                echo "‚ö†Ô∏è Calico not found, installing manually..."
                kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml
                echo "Waiting for Calico..."
                sleep 60
              fi
              
              echo "‚úÖ Setup complete"
              ;;
            "reset")
              echo "üîÑ Resetting Kubernetes cluster..."
              multipass exec k8s-master -- sudo bash -c "kubeadm reset -f && rm -rf /var/lib/etcd && rm -rf /etc/kubernetes/pki"
              multipass exec k8s-worker1 -- sudo kubeadm reset -f
              multipass exec k8s-worker2 -- sudo kubeadm reset -f
              echo "‚úÖ Cluster reset complete"
              ;;
            "rejoin-workers")
              echo "üîó Rejoining worker nodes..."
              # First ensure master is properly initialized
              MASTER_IP=$(multipass info k8s-master | grep IPv4 | awk '{print $2}')
              multipass exec k8s-master -- sudo bash -c "kubeadm reset -f && rm -rf /var/lib/etcd && rm -rf /etc/kubernetes/pki"
              multipass exec k8s-master -- sudo kubeadm init --pod-network-cidr=192.168.0.0/16 --apiserver-advertise-address=$MASTER_IP
              
              # Setup kubectl on master
              multipass exec k8s-master -- bash -c "mkdir -p /home/ubuntu/.kube && sudo cp /etc/kubernetes/admin.conf /home/ubuntu/.kube/config && sudo chown ubuntu:ubuntu /home/ubuntu/.kube/config"
              
              # Install Calico
              multipass exec k8s-master -- kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml
              
              # Wait for Calico to be ready
              echo "Waiting for Calico to be ready..."
              sleep 60
              
              # Get new join command
              JOIN_CMD=$(multipass exec k8s-master -- sudo kubeadm token create --print-join-command)
              multipass exec k8s-worker1 -- sudo kubeadm reset -f
              multipass exec k8s-worker2 -- sudo kubeadm reset -f
              multipass exec k8s-worker1 -- sudo $JOIN_CMD
              multipass exec k8s-worker2 -- sudo $JOIN_CMD
              echo "‚úÖ Workers rejoined"
              ;;
            "status")
              echo "üìä Kubernetes Cluster Status..."
              
              # Setup kubectl first
              mkdir -p ~/.kube
              if multipass exec k8s-master -- sudo cat /etc/kubernetes/admin.conf > ~/.kube/config 2>/dev/null; then
                echo "‚úÖ kubectl configured successfully"
                kubectl get nodes -o wide
                kubectl get pods --all-namespaces
                kubectl get svc --all-namespaces
              else
                echo "‚ùå No Kubernetes cluster found or cluster not initialized"
                echo "üí° Run 'setup' action first to initialize the cluster"
              fi
              ;;
            "restart-services")
              echo "üîÑ Restarting Kubernetes services..."
              multipass exec k8s-master -- sudo systemctl restart kubelet containerd
              multipass exec k8s-worker1 -- sudo systemctl restart kubelet containerd
              multipass exec k8s-worker2 -- sudo systemctl restart kubelet containerd
              echo "‚úÖ Services restarted"
              ;;
            "install-calico")
              echo "üåê Installing Calico network plugin..."
              
              # Setup kubectl
              mkdir -p ~/.kube
              multipass exec k8s-master -- sudo cat /etc/kubernetes/admin.conf > ~/.kube/config
              
              # Install Calico
              kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml
              
              echo "Waiting for Calico pods..."
              kubectl wait --for=condition=Ready pods --all -n calico-system --timeout=300s || echo "Calico taking longer than expected"
              
              echo "‚úÖ Calico installation complete"
              kubectl get pods -n calico-system
              kubectl get pods -n kube-system | grep coredns
              ;;
          esac
    
    - task: Bash@3
      displayName: 'Setup kubectl and Verify (setup/rejoin only)'
      condition: and(succeeded(), in(variables['action'], 'setup', 'rejoin-workers'))
      inputs:
        targetType: 'inline'
        script: |
          # Setup kubectl
          mkdir -p ~/.kube
          multipass exec k8s-master -- sudo cat /etc/kubernetes/admin.conf > ~/.kube/config
          
          # Also ensure kubectl is set up on master node
          multipass exec k8s-master -- bash -c "mkdir -p /home/ubuntu/.kube && sudo cp /etc/kubernetes/admin.conf /home/ubuntu/.kube/config && sudo chown ubuntu:ubuntu /home/ubuntu/.kube/config"
          
          # Verify cluster
          echo "üîç Cluster Status:"
          kubectl get nodes -o wide
          kubectl get pods --all-namespaces
          
          # Check if all nodes are ready
          NOT_READY=$(kubectl get nodes --no-headers | grep -v Ready | wc -l)
          if [ $NOT_READY -eq 0 ]; then
            echo "‚úÖ All nodes are Ready!"
          else
            echo "‚ö†Ô∏è Some nodes are not Ready"
            kubectl get nodes
          fi