trigger:
- main

pool:
  name: 'Default'

stages:
- stage: Kubernetes
  jobs:
  - job: SetupK8s
    steps:
    - task: Bash@3
      displayName: 'Generate and Commit Dynamic Inventory'
      inputs:
        targetType: 'inline'
        script: |
          echo "ðŸ” Detecting VM IPs..."
          
          # Get current VM IPs
          MASTER_IP=$(multipass info k8s-master | grep IPv4 | awk '{print $2}')
          WORKER1_IP=$(multipass info k8s-worker1 | grep IPv4 | awk '{print $2}')
          WORKER2_IP=$(multipass info k8s-worker2 | grep IPv4 | awk '{print $2}')
          
          echo "Master IP: $MASTER_IP"
          echo "Worker1 IP: $WORKER1_IP" 
          echo "Worker2 IP: $WORKER2_IP"
          
          # Generate dynamic inventory
          cat > ansible/inventory.ini << EOF
          [k8s_master]
          k8s-master ansible_host=$MASTER_IP ansible_user=ubuntu

          [k8s_workers]
          k8s-worker1 ansible_host=$WORKER1_IP ansible_user=ubuntu
          k8s-worker2 ansible_host=$WORKER2_IP ansible_user=ubuntu

          [k8s_cluster:children]
          k8s_master
          k8s_workers

          [all:vars]
          ansible_ssh_common_args='-o StrictHostKeyChecking=no'
          ansible_python_interpreter=/usr/bin/python3
          EOF
          
          echo "âœ… Generated dynamic inventory:"
          cat ansible/inventory.ini
          
          # Configure git and commit back to repo
          git config user.email "pipeline@azuredevops.com"
          git config user.name "Azure DevOps Pipeline"
          
          # Check if inventory changed
          if ! git diff --quiet ansible/inventory.ini; then
            echo "ðŸ“ Committing updated inventory..."
            git add ansible/inventory.ini
            git commit -m "Update inventory with current VM IPs [skip ci]"
            git push origin main
            echo "âœ… Inventory committed to repository"
          else
            echo "â„¹ï¸ Inventory unchanged, no commit needed"
          fi

    - task: Bash@3
      displayName: 'Setup Kubernetes with Ansible'
      inputs:
        targetType: 'inline'
        script: |
          # Install ansible if not present
          sudo apt update && sudo apt install -y ansible
          
          # Run ansible playbook with dynamic inventory
          ansible-playbook -i ansible/inventory.ini ansible/playbook.yml

- stage: Deploy
  dependsOn: Kubernetes
  jobs:
  - job: DeployApps
    steps:
    - task: Bash@3
      displayName: 'Deploy Applications'
      inputs:
        targetType: 'inline'
        script: |
          # Copy kubeconfig from master
          MASTER_IP=$(multipass info k8s-master | grep IPv4 | awk '{print $2}')
          multipass exec k8s-master -- sudo cat /etc/kubernetes/admin.conf > ~/.kube/config
          
          # Deploy applications
          kubectl apply -f k8s/nginx.yaml
          
          echo "âœ… Deployment Status:"
          kubectl get nodes -o wide
          kubectl get pods
          kubectl get svc nginx-service